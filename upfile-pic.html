<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>CSS 样式测试</title>
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui" media="(device-height:568px)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-touch-fullscreen" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/layout.css">
<link rel="stylesheet" href="css/demo.css">
<script src="js/zepto.min.js"></script>
<script src="js/plugins.js"></script>
<script src="js/controller/init.js"></script>
</head>
<body>
<div class="wrap">
  <!-- Header File Start -->
  <div id="header" class="header">
    <header>
      <h1>上传图片</h1>
      <a class="icon back" href="index.html"></a>
    </header>
  </div>
  <!-- Header File End -->

  <form class="form mt" action="#" method="post">
    <div class="mbox">
      <ul id="upfile_pic" class="upfile_pic clearfix">
        <!-- 已上传的图片（不允许删除） -->
        <li class="have" style="background-image:url(http://temp.im/100x100)"></li>

        <!-- 已上传的图片（允许删除） -->
        <li class="have" style="background-image:url(http://temp.im/100x100)">
          <a href="javascript://" rel="remove"></a>
        </li>

        <li>
          <label><input type="file" accept="image/*"></label>
          <a href="javascript://" rel="remove"></a>
        </li>
      </ul>
    </div>
  </form>
</div>

<script src="js/controller/reday.js"></script>
<script>
(function() {
  var upPicture = {
    dom: {},
    options: {
      max: 9,
      maxWidth: 200,
      maxHeight: 200,
      haveClass: 'have'
    }
  };

  upPicture.init = function() {
    var self = this;

    self.dom.list = $('#upfile_pic');
    self.dom.faceCanvas = document.createElement('canvas');
    self.tmpHtml = $('<div></div>').html(self.dom.list.find('li').last().clone()).html();

    self.options = $.extend({}, self.options, {
      max: self.dom.list.data('max')
    });

    self.dom.list.on('click', 'a', function() {
      var _rel = this.rel;

      if (_rel === 'remove') {
        $(this).closest('li').remove();
        self.addFile();
        return false;
      };
    });

    self.dom.list.on('change', 'input', function() {
      if (this.type === 'file') {
        var file = this.files[0];
        var mpImg = new MegaPixImage(file);
        var _li = $(this).closest('li');

        mpImg.render(self.dom.faceCanvas, {
          maxWidth: self.options.maxWidth,
          maxHeight: self.options.maxHeight
        });

        // 裁切图片需要少许时间，延时转换图片数据
        setTimeout(function() {
          var _sImgData = self.dom.faceCanvas.toDataURL();

          _li.addClass(self.options.haveClass).css({
            'backgroundImage': 'url(' + _sImgData + ')'
          });

          self.addFile();
        }, 200);
      };
    });
  };

  upPicture.addFile = function() {
    var self = this;

    if (self.dom.list.find('li').length < self.options.max && self.dom.list.find('li').last().hasClass(self.options.haveClass)) {
      self.dom.list.append(self.tmpHtml);
    };
  };

  upPicture.init();
})();
</script>
</body>
</html>
